# Mattermost AKS Automated Deployment

Automated deployment scripts for running Mattermost on Azure Kubernetes Service (AKS) with modern infrastructure:

- **Azure Application Gateway for Containers** (Gateway API)
- **cert-manager** for automated TLS certificates
- **PostgreSQL Flexible Server** for database
- **Multiple storage options**: MinIO, NFS, or s3proxy

## Quick Start

```bash
# 1. Create configuration file with secure passwords
make env

# 2. Edit .env and set your domain and email
vim .env

# 3. Deploy with MinIO storage (creates everything)
make deploy-minio

# 4. Get Gateway IP and configure DNS
make gateway-ip

# 5. When done testing, tear down everything
make teardown
```

## Prerequisites

- Azure CLI (`az`) installed and logged in
- `kubectl` installed
- Active Azure subscription
- Domain name with ability to configure DNS

## Configuration

All configuration is managed via `.env` file:

1. **Create .env**: `make env` copies `example.env` and generates secure 32-character random passwords
2. **Edit .env**: Update `DOMAIN` and `EMAIL` with your values

### Required Configuration

```bash
# Azure Resources
RESOURCE_GROUP=mattermost-test-rg
CLUSTER_NAME=mattermost-test-aks
LOCATION=eastus2

# Domain and TLS
DOMAIN=mattermost.example.com    # UPDATE THIS
EMAIL=admin@example.com           # UPDATE THIS

# Passwords (auto-generated by make env)
POSTGRES_PASSWORD=<secure-random-password>
MINIO_ADMIN_PASSWORD=<secure-random-password>
MINIO_SERVICE_PASSWORD=<secure-random-password>
S3PROXY_PASSWORD=<secure-random-password>
```

### Optional Configuration

```bash
# License file (optional, for Enterprise features)
LICENSE_FILE=license.mattermost
```

## Make Targets

### Deployment

- `make deploy-minio` - Deploy complete stack with MinIO storage
- `make deploy-nfs` - Switch to NFS storage (Azure Files Premium)
- `make deploy-s3proxy` - Switch to s3proxy + Azure Blob Storage

### Management

- `make status` - Show status of all resources
- `make gateway-ip` - Get Gateway external IP address
- `make teardown` - Delete entire resource group

### Testing

- `make test-minio` - Test MinIO deployment
- `make test-nfs` - Test NFS deployment
- `make test-s3proxy` - Test s3proxy deployment

### Logs

- `make logs-mattermost` - Stream Mattermost pod logs
- `make logs-minio` - Stream MinIO tenant logs
- `make logs-s3proxy` - Stream s3proxy logs

### Cleanup

- `make clean` - Remove generated YAML files

## Storage Options

### MinIO (Default)

**Use when**: You need full S3 API compatibility

```bash
make deploy-minio
```

- Native S3 API implementation
- Distributed storage with multiple servers
- Uses Azure Blob NFS Premium storage (200Gi)
- Best for production workloads requiring S3 features

### NFS

**Use when**: You want maximum performance and simplicity

```bash
make deploy-nfs
```

- Direct filesystem access (no S3 translation)
- Azure Files Premium with NFS 4.1
- Simpler architecture than object storage
- Best for high-throughput file operations

### s3proxy

**Use when**: You want to minimize costs

```bash
make deploy-s3proxy
```

- Translates S3 API to Azure Blob Storage
- Pay-per-use Azure Storage pricing
- Lower infrastructure costs than MinIO
- Best for cost-sensitive deployments

## DNS and TLS Automation

The deployment follows a phased approach for TLS certificate provisioning:

1. **Deploy HTTP-only Gateway** - Gets external IP from Azure
2. **Configure DNS** - Point your domain to the Gateway IP
3. **Request Certificate** - Let's Encrypt validates via HTTP-01 challenge
4. **Add HTTPS Listener** - Gateway serves traffic over TLS

See [DNS-TLS-AUTOMATION.md](DNS-TLS-AUTOMATION.md) for detailed coordination steps.

## Architecture

### Created Resources

**Azure Resources:**
- AKS cluster (Azure CNI, Workload Identity, OIDC)
- PostgreSQL Flexible Server v18
- Azure Storage Account (for s3proxy option)
- Azure Files Premium (for NFS option)
- Managed Identity for ALB Controller

**Kubernetes Resources:**
- cert-manager (TLS certificate management)
- Azure ALB Controller (Gateway API implementation)
- MinIO Operator and Tenant (for MinIO option)
- s3proxy deployment (for s3proxy option)
- Mattermost Operator
- Mattermost instance

### Network Architecture

```
Internet → Gateway (ALB) → HTTPRoute → Mattermost Service → Mattermost Pods
                            ↓
                      TLS Certificate (Let's Encrypt)
```

## Cost Estimates

**Estimated daily costs (East US 2):**
- AKS cluster (2 Standard_D4s_v4 nodes): ~$5.76/day
- PostgreSQL Flexible Server (Burstable B1ms): ~$0.72/day
- MinIO storage (azureblob-nfs-premium 200Gi): ~$1.00/day
- NFS storage (Azure Files Premium 200Gi): ~$1.00/day
- s3proxy storage (Azure Blob): Pay per usage

**Total: ~$8-10/day depending on storage option**

**Important:** Run `make teardown` when done to avoid ongoing charges!

## Troubleshooting

### Gateway not getting IP

```bash
kubectl logs -n azure-alb-system deployment/alb-controller
kubectl describe gateway mattermost-gateway -n mattermost
```

### Certificate not provisioning

```bash
kubectl logs -n cert-manager deployment/cert-manager
kubectl describe certificate mattermost-tls-cert -n mattermost
kubectl get challenges -n mattermost
```

### Mattermost not starting

```bash
make logs-mattermost
kubectl describe mm mattermost -n mattermost
kubectl logs -n mattermost-operator deployment/mattermost-operator
```

### MinIO issues

```bash
kubectl get pods -n mattermost-minio
kubectl describe tenant minio-mattermost -n mattermost-minio
kubectl logs -n minio-operator deployment/minio-operator
```

### s3proxy issues

```bash
make logs-s3proxy
kubectl describe deployment s3proxy -n s3proxy
az storage blob list --account-name <name> --container-name mattermost
```

## Development Workflow

### Test All Storage Options

```bash
# 1. Deploy and test MinIO
make deploy-minio
# Test file operations...

# 2. Switch to NFS and test
make deploy-nfs
# Test file operations...

# 3. Switch to s3proxy and test
make deploy-s3proxy
# Test file operations...

# 4. Clean up
make teardown
```

### Update Scripts

After modifying deployment scripts:

1. Test on clean deployment
2. Verify idempotency (run twice)
3. Test teardown
4. Update PLAN.md with findings

## Manual Deployment

For manual step-by-step deployment instructions, see:
- [Mattermost-azure-kubernetes](https://github.com/yourusername/Mattermost-azure-kubernetes) - Manual deployment guide with example YAML files

## Security Notes

- Scripts validate `.env` exists before running
- Scripts refuse to run with placeholder passwords
- `generate-secrets.sh` creates strong 32-character random passwords
- `.env` is in `.gitignore` to prevent accidental commits
- PostgreSQL uses `--public-access 0.0.0.0` (Azure IPs only, not internet)

**For production:**
- Use Azure Key Vault for secrets
- Enable Pod Security Standards
- Configure network policies
- Use private endpoints for PostgreSQL
- Enable AKS managed identity for pod identities

## Files Reference

### Configuration
- `.env` - Deployment configuration (gitignored, create with `make env`)
- `example.env` - Configuration template
- `license.mattermost` - Mattermost license file (optional, gitignored)

### Scripts
- `scripts/deploy-minio.sh` - Full deployment with MinIO
- `scripts/deploy-nfs.sh` - Deploy with NFS storage
- `scripts/deploy-s3proxy.sh` - Deploy with s3proxy
- `scripts/generate-secrets.sh` - Generate secure passwords

### Documentation
- `README.md` - This file
- `DRAFT.md` - Manual deployment instructions (reference)
- `PLAN.md` - Development planning and testing notes
- `DNS-TLS-AUTOMATION.md` - TLS certificate coordination guide
- `CLAUDE.md` - AI assistant context for development

## License

This project is provided as-is for deploying Mattermost on Azure Kubernetes Service. Mattermost itself is licensed separately.
